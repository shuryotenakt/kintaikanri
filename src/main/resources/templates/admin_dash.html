<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .edit-panel {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px;
            display: inline-block;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container">
            <span class="navbar-brand">ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š[[${session.user.name}]]ï¼‰</span>
            <div class="d-flex gap-2">
                <a href="/partner" class="btn btn-outline-warning btn-sm">â¬… æ‰“åˆ»ç”»é¢ã¸</a>
                <a href="/logout" class="btn btn-outline-light btn-sm">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>

        <div class="row">
            <div class="col-md-3">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</div>
                    <div class="card-body">
                        <form action="/admin/register" method="post" autocomplete="off">
                            <input type="text" name="name" class="form-control mb-2" placeholder="æ°å" required autocomplete="off">
                            <input type="password" name="password" class="form-control mb-2" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required autocomplete="new-password">
                            <select name="role" class="form-select mb-3">
                                <option value="PARTNER">ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ç¤¾å“¡</option>
                                <option value="ADMIN">ç®¡ç†è€…</option>
                            </select>
                            <button type="submit" class="btn btn-primary w-100">ç™»éŒ²</button>
                        </form>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white fw-bold">å¾“æ¥­å“¡ç®¡ç†</div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center" th:each="u : ${userList}">
                            <span>
                                <span class="fw-bold">[[${u.name}]]</span>
                                <span class="text-muted small">([[${u.userId}]])</span>
                                <span th:if="${u.role == 'ADMIN'}" class="badge bg-warning text-dark ms-1">Admin</span>
                            </span>
                            <button class="btn btn-outline-danger btn-sm" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#deleteModal"
                                    th:data-id="${u.id}" 
                                    th:data-name="${u.name}"
                                    onclick="setDeleteTarget(this)">
                                å‰Šé™¤
                            </button>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="col-md-9">
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <div class="fw-bold mb-2">æ‰“åˆ»å±¥æ­´ç®¡ç†</div>
                        <form action="/admin" method="get" id="filterForm" class="d-flex flex-wrap align-items-center gap-3 bg-light p-2 rounded border">
                            
                            <div class="d-flex align-items-center gap-1">
                                <span class="small fw-bold text-muted text-nowrap">å¾“æ¥­å“¡:</span>
                                <select name="userId" class="form-select form-select-sm" style="width: 150px;" onchange="document.getElementById('filterForm').submit()">
                                    <option value="">å…¨å“¡ã‚’è¡¨ç¤º</option>
                                    <option th:each="u : ${userList}" 
                                            th:value="${u.userId}" 
                                            th:text="${u.name} + ' (' + ${u.userId} + ')'"
                                            th:selected="${u.userId == selectedUserId}">
                                    </option>
                                </select>
                            </div>

                            <div class="d-flex align-items-center gap-1 border-start ps-3">
                                <span class="small fw-bold text-muted text-nowrap">æœˆ:</span>
                                <input type="month" name="month" id="monthInput" th:value="${selectedMonth}" class="form-control form-control-sm" onchange="onMonthChange()">
                            </div>

                            <div class="d-flex align-items-center gap-1 border-start ps-3">
                                <span class="small fw-bold text-muted text-nowrap">æ—¥ä»˜:</span>
                                <input type="date" name="startDate" id="startDateInput" th:value="${selectedStartDate}" class="form-control form-control-sm" onchange="onDateChange()">
                                <span class="text-muted">ï½</span>
                                <input type="date" name="endDate" id="endDateInput" th:value="${selectedEndDate}" class="form-control form-control-sm" onchange="onDateChange()">
                            </div>

                            <div class="ms-auto">
                                <a href="/admin" class="btn btn-outline-secondary btn-sm">ã‚¯ãƒªã‚¢</a>
                            </div>
                        </form>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 20%;">åå‰(ID)</th>
                                    <th style="width: 65%;">å‹¤å‹™å®Ÿç¸¾ / ä¿®æ­£ãƒ•ã‚©ãƒ¼ãƒ </th>
                                    <th style="width: 15%;">åŠ´åƒæ™‚é–“</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="h : ${histories}">
                                    <td>
                                        <span class="fw-bold">[[${h.userName}]]</span><br>
                                        <small class="text-muted">ID: [[${h.userId}]]</small>
                                    </td>
                                    
                                    <td>
                                        <div class="mb-2">
                                            <span class="badge bg-secondary mb-1">è¨˜éŒ²</span><br>
                                            <span class="fs-5 fw-bold text-dark">
                                                <span th:text="${#temporals.format(h.startTime, 'yyyy/MM/dd HH:mm')}"></span>
                                                <span class="text-muted mx-2">ï½</span>
                                                <span th:text="${h.endTime != null ? #temporals.format(h.endTime, 'HH:mm') : 'æœªé€€å‹¤'}"></span>
                                            </span>
                                        </div>
                                        
                                        <div class="edit-panel">
                                            <form action="/admin/edit" method="post" class="d-flex align-items-center gap-2 m-0">
                                                <input type="hidden" name="id" th:value="${h.id}">
                                                <span class="text-muted small fw-bold">ä¿®æ­£:</span>
                                                <input type="datetime-local" name="startTime" 
                                                       th:value="${#temporals.format(h.startTime, 'yyyy-MM-dd''T''HH:mm')}" 
                                                       class="form-control form-control-sm" style="width: auto;">
                                                <span class="text-muted small">ï½</span>
                                                <input type="datetime-local" name="endTime" 
                                                       th:value="${h.endTime != null ? #temporals.format(h.endTime, 'yyyy-MM-dd''T''HH:mm') : ''}" 
                                                       class="form-control form-control-sm" style="width: auto;">
                                                <button type="submit" class="btn btn-warning btn-sm fw-bold shadow-sm">ä¸Šæ›¸ãä¿å­˜</button>
                                            </form>
                                        </div>
                                    </td>

                                    <td>
                                        <span class="badge bg-success fs-6" th:text="${h.workTime}"></span>
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(histories)}">
                                    <td colspan="3" class="text-center text-muted py-4">å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã®ç¢ºèª</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>æœ¬å½“ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ <strong id="deleteTargetName"></strong> ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ<br>
                    <span class="text-danger small">â€»ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚</span></p>
                    
                    <form action="/admin/delete-user" method="post">
                        <input type="hidden" name="targetId" id="deleteTargetId">
                        <div class="mb-3">
                            <label class="form-label fw-bold">ç®¡ç†è€…ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›</label>
                            <input type="password" name="adminPassword" class="form-control" required>
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button type="submit" class="btn btn-danger">å‰Šé™¤å®Ÿè¡Œ</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        function setDeleteTarget(button) {
            var id = button.getAttribute('data-id');
            var name = button.getAttribute('data-name');
            document.getElementById('deleteTargetId').value = id;
            document.getElementById('deleteTargetName').textContent = name;
        }

        // ğŸ†• æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã®æ’ä»–åˆ¶å¾¡ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
        function onMonthChange() {
            // æœˆãŒé¸ã°ã‚ŒãŸã‚‰ã€æœŸé–“æŒ‡å®šã®ç®±ã‚’ç©ºã«ã—ã¦ã‹ã‚‰æ¤œç´¢å®Ÿè¡Œ
            document.getElementById('startDateInput').value = '';
            document.getElementById('endDateInput').value = '';
            document.getElementById('filterForm').submit();
        }

        function onDateChange() {
            // æœŸé–“ãŒé¸ã°ã‚ŒãŸã‚‰ã€æœˆæŒ‡å®šã®ç®±ã‚’ç©ºã«ã™ã‚‹
            document.getElementById('monthInput').value = '';
            
            // é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ãŒä¸¡æ–¹åŸ‹ã¾ã£ãŸæ™‚ã ã‘è‡ªå‹•ã§æ¤œç´¢å®Ÿè¡Œ
            var start = document.getElementById('startDateInput').value;
            var end = document.getElementById('endDateInput').value;
            if (start && end) {
                document.getElementById('filterForm').submit();
            }
        }
    </script>
</body>
</html>